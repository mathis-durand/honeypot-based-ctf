# Use the Docker-in-Docker (DinD) image.
FROM docker:dind

# Set the working directory
WORKDIR /app

# INSTALL PACKAGES
RUN apk add --no-cache bash \
        python3 py3-pip \
#        openssh \
        util-linux \ 
        coreutils \
        nmap

# log folders
RUN mkdir /app/dind/logs
RUN mkdir /msg
RUN mkdir /logs
RUN mkdir /logs/-1 /logs/0 /logs/1 /logs/2 /logs/3 /logs/4 /logs/5  /logs/6 /logs/7 /logs/8
echo 0 > /app/dind/.gen

# COPY FILES
COPY ./dind ./dind
COPY ./ssh ./ssh
COPY ./lobby ./lobby
COPY ./config ./config

ARG SSH_USER='nobody1'
ARG SSH_PASS='password'


# %%
# LOGS
# %%

RUN mkdir /logs

# %%
# START
# %%

RUN chmod +x /app/dind/start.sh
RUN chmod 600 /app/config/log_key

# Expose SSH Port
EXPOSE 2222

# Run the build and run script, and then the log analyzer in the background
CMD ["/app/dind/start.sh"]


